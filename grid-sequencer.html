<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grid Sound Sequencer with Audio Plugins</title>
    <style>
        :root {
            --primary-color: #6200ea;
            --secondary-color: #3700b3;
            --bg-color: #121212;
            --grid-color: #2d2d2d;
            --active-color: #bb86fc;
            --text-color: #ffffff;
            --cell-size: 40px;
            --white-key-color: #ffffff;
            --black-key-color: #333333;
            --white-key-active: #bb86fc;
            --black-key-active: #7f39fb;
            --key-border-color: #555555;
            --tab-active: #6200ea;
            --tab-inactive: #3700b3;
            --brass-color: #FFA500;
            --string-color: #00C853;
            --plugin-bg: #222222;
            --slider-color: #8e44ad;
            --slider-thumb: #bb86fc;
        }

        body {
            font-family: 'Roboto', Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            overflow-x: hidden;
        }

        h1 {
            color: var(--active-color);
            margin-bottom: 10px;
        }

        .controls {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
            gap: 10px;
            flex-wrap: wrap;
        }

        button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }

        button:hover {
            background-color: var(--secondary-color);
        }

        .transport-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .slider-container {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 10px 0;
        }

        .slider-container label {
            min-width: 120px;
        }

        input[type="range"] {
            width: 200px;
            height: 6px;
            background: #333;
            outline: none;
            border-radius: 3px;
            -webkit-appearance: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            background: var(--slider-thumb);
            border-radius: 50%;
            cursor: pointer;
        }

        .value-display {
            min-width: 60px;
            text-align: center;
        }

        .grid-container {
            display: flex;
            flex-direction: column;
            background-color: var(--grid-color);
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            overflow-x: auto;
            max-width: 100%;
            width: 100%;
        }

        .grid-row {
            display: flex;
            margin-bottom: 5px;
        }

        .row-label {
            width: 100px;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 10px;
            font-weight: bold;
            color: var(--text-color);
        }

        .grid-cells {
            display: flex;
        }

        .grid-cell {
            width: var(--cell-size);
            height: var(--cell-size);
            background-color: rgba(255, 255, 255, 0.1);
            margin-right: 5px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .grid-cell:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }

        .grid-cell.active {
            background-color: var(--active-color);
        }

        .grid-cell.playing {
            box-shadow: 0 0 10px 2px var(--active-color);
        }

        .beat-markers {
            display: flex;
            margin-left: 100px;
            margin-bottom: 5px;
        }

        .beat-marker {
            width: var(--cell-size);
            text-align: center;
            margin-right: 5px;
            font-size: 14px;
            color: rgba(255, 255, 255, 0.7);
        }

        /* Tabs styles */
        .tabs {
            display: flex;
            margin-bottom: 20px;
            width: 100%;
            max-width: 800px;
            flex-wrap: wrap;
        }
        
        .tab {
            flex: 1;
            padding: 10px 20px;
            text-align: center;
            background-color: var(--tab-inactive);
            color: white;
            cursor: pointer;
            border-radius: 4px 4px 0 0;
            margin-right: 2px;
            user-select: none;
            font-weight: bold;
            min-width: 150px;
        }
        
        .tab.active {
            background-color: var(--tab-active);
        }
        
        .tab-content {
            display: none;
            width: 100%;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* Piano styles */
        .piano-container {
            width: 100%;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: var(--grid-color);
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }
        
        .piano {
            display: flex;
            position: relative;
            width: 100%;
            height: 200px;
            margin-bottom: 20px;
            user-select: none;
        }
        
        .octave {
            display: flex;
            position: relative;
            height: 100%;
            flex: 1;
        }
        
        .key {
            border: 1px solid var(--key-border-color);
            box-sizing: border-box;
            position: relative;
        }
        
        .white-key {
            background-color: var(--white-key-color);
            flex: 1;
            height: 100%;
            z-index: 1;
            border-radius: 0 0 4px 4px;
        }
        
        .white-key.active {
            background-color: var(--white-key-active);
        }
        
        .black-key {
            background-color: var(--black-key-color);
            width: 60%;
            height: 65%;
            position: absolute;
            z-index: 2;
            border-radius: 0 0 4px 4px;
        }
        
        .black-key.active {
            background-color: var(--black-key-active);
        }
        
        .key-label {
            position: absolute;
            bottom: 10px;
            left: 0;
            right: 0;
            text-align: center;
            font-size: 12px;
            color: var(--text-color);
            pointer-events: none;
        }
        
        .white-key .key-label {
            color: #333;
        }
        
        .black-key .key-label {
            color: white;
            bottom: 5px;
        }
        
        .instrument-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .instrument-control-group {
            display: flex;
            align-items: center;
            margin: 10px;
            gap: 10px;
        }
        
        .instrument-label {
            min-width: 100px;
        }
        
        .note-display {
            min-width: 120px;
            height: 40px;
            line-height: 40px;
            text-align: center;
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            margin-left: 10px;
        }
        
        /* Instrument grid */
        .instrument-grid-container {
            display: flex;
            flex-direction: column;
            background-color: var(--grid-color);
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            overflow-x: auto;
            max-width: 100%;
            margin-top: 20px;
        }
        
        .instrument-grid-row {
            display: flex;
            margin-bottom: 5px;
        }
        
        .note-label {
            width: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 12px;
            color: var(--text-color);
        }
        
        .instrument-grid-cells {
            display: flex;
        }
        
        .instrument-grid-cell {
            width: var(--cell-size);
            height: var(--cell-size);
            background-color: rgba(255, 255, 255, 0.1);
            margin-right: 5px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .instrument-grid-cell:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }
        
        .instrument-grid-cell.active {
            background-color: var(--active-color);
        }
        
        .instrument-grid-cell.playing {
            box-shadow: 0 0 10px 2px var(--active-color);
        }
        
        /* Button to add notes to the grid */
        .add-note-btn {
            background-color: var(--primary-color);
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 20px;
        }
        
        .add-note-btn:hover {
            background-color: var(--secondary-color);
        }

        /* Brass specific styles */
        .brass-grid-cell.active {
            background-color: var(--brass-color);
        }
        
        .brass-grid-cell.playing {
            box-shadow: 0 0 10px 2px var(--brass-color);
        }

        /* Strings specific styles */
        .strings-grid-cell.active {
            background-color: var(--string-color);
        }
        
        .strings-grid-cell.playing {
            box-shadow: 0 0 10px 2px var(--string-color);
        }
        
        /* Audio Plugin Styles */
        .plugins-container {
            width: 100%;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: var(--grid-color);
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }
        
        .plugin-row {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 20px;
            justify-content: space-between;
        }
        
        .plugin-card {
            background-color: var(--plugin-bg);
            border-radius: 8px;
            padding: 15px;
            flex: 1;
            min-width: 250px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
        }
        
        .plugin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding-bottom: 10px;
        }
        
        .plugin-title {
            font-weight: bold;
            font-size: 18px;
            color: var(--active-color);
        }
        
        .plugin-toggle {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }
        
        .plugin-toggle input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .plugin-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #444;
            transition: .3s;
            border-radius: 24px;
        }
        
        .plugin-slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .3s;
            border-radius: 50%;
        }
        
        input:checked + .plugin-slider {
            background-color: var(--active-color);
        }
        
        input:checked + .plugin-slider:before {
            transform: translateX(26px);
        }
        
        .plugin-controls {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .plugin-control {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .plugin-control label {
            font-size: 14px;
            opacity: 0.8;
        }
        
        .plugin-control input[type="range"] {
            width: 100%;
            background: #444;
        }
        
        .plugin-control input[type="range"]::-webkit-slider-thumb {
            background: var(--slider-color);
        }
        
        .plugin-value {
            font-size: 12px;
            text-align: right;
            opacity: 0.7;
        }
        
        /* EQ Visualization */
        .eq-visualization {
            height: 100px;
            background-color: rgba(255, 255, 255, 0.05);
            border-radius: 4px;
            margin-top: 10px;
            position: relative;
            overflow: hidden;
        }
        
        .eq-line {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            stroke: var(--active-color);
            stroke-width: 2;
            fill: none;
        }
        
        .eq-point {
            position: absolute;
            width: 8px;
            height: 8px;
            background-color: var(--active-color);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            cursor: move;
        }
        
        /* Master Output Meter */
        .output-meter-container {
            display: flex;
            flex-direction: column;
            gap: 5px;
            margin-top: 20px;
        }
        
        .output-meter-label {
            font-size: 14px;
            font-weight: bold;
        }
        
        .output-meter {
            height: 20px;
            background-color: #333;
            border-radius: 4px;
            overflow: hidden;
        }
        
        .output-meter-level {
            height: 100%;
            width: 0%;
            background: linear-gradient(to right, #4CAF50, #FFEB3B, #FF5722);
            transition: width 0.1s;
        }
        
        /* Plugin preset styles */
        .preset-selector {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 15px;
        }
        
        .preset-selector select {
            background-color: #333;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            flex: 1;
        }
        
        @media (max-width: 768px) {
            :root {
                --cell-size: 30px;
            }
            
            .row-label {
                width: 80px;
                font-size: 14px;
            }
            
            .controls {
                flex-direction: column;
                align-items: center;
            }
            
            .slider-container {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .piano {
                height: 150px;
            }
            
            .key-label {
                font-size: 10px;
            }
            
            .plugin-row {
                flex-direction: column;
            }
            
            .plugin-card {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <h1>Grid Sound Sequencer with Audio Plugins</h1>
    
    <div class="controls">
        <div class="transport-controls">
            <button id="play-button">Play</button>
            <button id="stop-button">Stop</button>
            <button id="clear-all-button">Clear All</button>
        </div>
        
        <div class="slider-container">
            <label for="tempo-slider">Tempo:</label>
            <input type="range" id="tempo-slider" min="60" max="200" value="120">
            <div id="tempo-value" class="value-display">120 BPM</div>
        </div>
        
        <div class="slider-container">
            <label for="volume-slider">Master Volume:</label>
            <input type="range" id="volume-slider" min="0" max="100" value="75">
            <div id="volume-value" class="value-display">75%</div>
        </div>
    </div>
    
    <!-- Tabs for switching between instruments and plugins -->
    <div class="tabs">
        <div class="tab active" data-tab="drums" onclick="switchTab('drums')">Drum Sequencer</div>
        <div class="tab" data-tab="piano" onclick="switchTab('piano')">Piano</div>
        <div class="tab" data-tab="brass" onclick="switchTab('brass')">Brass</div>
        <div class="tab" data-tab="strings" onclick="switchTab('strings')">Strings</div>
        <div class="tab" data-tab="plugins" onclick="switchTab('plugins')">Audio Plugins</div>
    </div>
    
    <!-- Drum Sequencer Tab -->
    <div class="tab-content active" id="drums-tab" style="display:block;">
        <div class="grid-container">
            <div class="beat-markers" id="beat-markers"></div>
            <div id="grid"></div>
        </div>
    </div>
    
    <!-- Piano Tab -->
    <div class="tab-content" id="piano-tab" style="display:none;">
        <div class="piano-container">
            <div class="instrument-controls">
                <div class="instrument-control-group">
                    <label class="instrument-label">Octave:</label>
                    <button id="piano-octave-down">-</button>
                    <div id="piano-octave-display" class="value-display">4</div>
                    <button id="piano-octave-up">+</button>
                </div>
                
                <div class="instrument-control-group">
                    <label class="instrument-label">Piano Type:</label>
                    <select id="piano-type-select">
                        <option value="grand">Grand Piano</option>
                        <option value="electric">Electric Piano</option>
                        <option value="honky">Honky Tonk</option>
                    </select>
                </div>
                
                <div class="instrument-control-group">
                    <div id="piano-current-note" class="note-display">-</div>
                </div>
            </div>
            
            <div class="piano" id="piano-keyboard"></div>
            
            <div class="instrument-grid-container">
                <div class="beat-markers" id="piano-beat-markers"></div>
                <div id="piano-grid"></div>
            </div>
            
            <button id="piano-add-note-btn" class="add-note-btn">Add Current Note to Grid</button>
        </div>
    </div>
    
    <!-- Brass Tab -->
    <div class="tab-content" id="brass-tab" style="display:none;">
        <div class="piano-container">
            <div class="instrument-controls">
                <div class="instrument-control-group">
                    <label class="instrument-label">Octave:</label>
                    <button id="brass-octave-down">-</button>
                    <div id="brass-octave-display" class="value-display">4</div>
                    <button id="brass-octave-up">+</button>
                </div>
                
                <div class="instrument-control-group">
                    <label class="instrument-label">Brass Type:</label>
                    <select id="brass-type-select">
                        <option value="trumpet">Trumpet</option>
                        <option value="trombone">Trombone</option>
                        <option value="horn">French Horn</option>
                        <option value="tuba">Tuba</option>
                    </select>
                </div>
                
                <div class="instrument-control-group">
                    <div id="brass-current-note" class="note-display">-</div>
                </div>
            </div>
            
            <div class="piano" id="brass-keyboard"></div>
            
            <div class="instrument-grid-container">
                <div class="beat-markers" id="brass-beat-markers"></div>
                <div id="brass-grid"></div>
            </div>
            
            <button id="brass-add-note-btn" class="add-note-btn">Add Current Note to Grid</button>
        </div>
    </div>
    
    <!-- Strings Tab -->
    <div class="tab-content" id="strings-tab" style="display:none;">
        <div class="piano-container">
            <div class="instrument-controls">
                <div class="instrument-control-group">
                    <label class="instrument-label">Octave:</label>
                    <button id="strings-octave-down">-</button>
                    <div id="strings-octave-display" class="value-display">4</div>
                    <button id="strings-octave-up">+</button>
                </div>
                
                <div class="instrument-control-group">
                    <label class="instrument-label">String Type:</label>
                    <select id="strings-type-select">
                        <option value="violin">Violin</option>
                        <option value="viola">Viola</option>
                        <option value="cello">Cello</option>
                        <option value="ensemble">String Ensemble</option>
                    </select>
                </div>
                
                <div class="instrument-control-group">
                    <div id="strings-current-note" class="note-display">-</div>
                </div>
            </div>
            
            <div class="piano" id="strings-keyboard"></div>
            
            <div class="instrument-grid-container">
                <div class="beat-markers" id="strings-beat-markers"></div>
                <div id="strings-grid"></div>
            </div>
            
            <button id="strings-add-note-btn" class="add-note-btn">Add Current Note to Grid</button>
        </div>
    </div>
    
    <!-- Audio Plugins Tab -->
    <div class="tab-content" id="plugins-tab" style="display:none;">
        <div class="plugins-container">
            <h2>Master Audio Effects</h2>
            
            <!-- Output Level Meters -->
            <div class="output-meter-container">
                <div class="output-meter-label">Master Output Level</div>
                <div class="output-meter">
                    <div id="master-meter-level" class="output-meter-level"></div>
                </div>
            </div>
            
            <!-- First Row of Plugins -->
            <div class="plugin-row">
                <!-- Equalizer -->
                <div class="plugin-card">
                    <div class="plugin-header">
                        <div class="plugin-title">3-Band EQ</div>
                        <label class="plugin-toggle">
                            <input type="checkbox" id="eq-toggle" checked>
                            <span class="plugin-slider"></span>
                        </label>
                    </div>
                    <div class="plugin-controls">
                        <div class="plugin-control">
                            <label>Low (100Hz)</label>
                            <input type="range" id="eq-low" min="-12" max="12" value="0" step="0.5">
                            <div class="plugin-value" id="eq-low-value">0 dB</div>
                        </div>
                        <div class="plugin-control">
                            <label>Mid (1kHz)</label>
                            <input type="range" id="eq-mid" min="-12" max="12" value="0" step="0.5">
                            <div class="plugin-value" id="eq-mid-value">0 dB</div>
                        </div>
                        <div class="plugin-control">
                            <label>High (10kHz)</label>
                            <input type="range" id="eq-high" min="-12" max="12" value="0" step="0.5">
                            <div class="plugin-value" id="eq-high-value">0 dB</div>
                        </div>
                    </div>
                    <div class="eq-visualization">
                        <svg width="100%" height="100%" id="eq-curve">
                            <path class="eq-line" d="M0,50 L100,50 L200,50" />
                        </svg>
                    </div>
                    <div class="preset-selector">
                        <label>Preset:</label>
                        <select id="eq-preset">
                            <option value="flat">Flat</option>
                            <option value="bass-boost">Bass Boost</option>
                            <option value="mid-scoop">Mid Scoop</option>
                            <option value="treble-boost">Treble Boost</option>
                            <option value="vocal">Vocal Enhance</option>
                        </select>
                    </div>
                </div>
                
                <!-- Compressor -->
                <div class="plugin-card">
                    <div class="plugin-header">
                        <div class="plugin-title">Compressor</div>
                        <label class="plugin-toggle">
                            <input type="checkbox" id="comp-toggle" checked>
                            <span class="plugin-slider"></span>
                        </label>
                    </div>
                    <div class="plugin-controls">
                        <div class="plugin-control">
                            <label>Threshold</label>
                            <input type="range" id="comp-threshold" min="-60" max="0" value="-24" step="1">
                            <div class="plugin-value" id="comp-threshold-value">-24 dB</div>
                        </div>
                        <div class="plugin-control">
                            <label>Ratio</label>
                            <input type="range" id="comp-ratio" min="1" max="20" value="4" step="0.5">
                            <div class="plugin-value" id="comp-ratio-value">4:1</div>
                        </div>
                        <div class="plugin-control">
                            <label>Attack</label>
                            <input type="range" id="comp-attack" min="0.001" max="1" value="0.1" step="0.001">
                            <div class="plugin-value" id="comp-attack-value">0.1 s</div>
                        </div>
                        <div class="plugin-control">
                            <label>Release</label>
                            <input type="range" id="comp-release" min="0.01" max="1" value="0.2" step="0.01">
                            <div class="plugin-value" id="comp-release-value">0.2 s</div>
                        </div>
                    </div>
                    <div class="preset-selector">
                        <label>Preset:</label>
                        <select id="comp-preset">
                            <option value="gentle">Gentle</option>
                            <option value="moderate">Moderate</option>
                            <option value="aggressive">Aggressive</option>
                            <option value="limiter">Limiter</option>
                            <option value="drums">Drums</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <!-- Second Row of Plugins -->
            <div class="plugin-row">
                <!-- Reverb -->
                <div class="plugin-card">
                    <div class="plugin-header">
                        <div class="plugin-title">Reverb</div>
                        <label class="plugin-toggle">
                            <input type="checkbox" id="reverb-toggle">
                            <span class="plugin-slider"></span>
                        </label>
                    </div>
                    <div class="plugin-controls">
                        <div class="plugin-control">
                            <label>Room Size</label>
                            <input type="range" id="reverb-size" min="0.1" max="0.9" value="0.5" step="0.01">
                            <div class="plugin-value" id="reverb-size-value">0.5</div>
                        </div>
                        <div class="plugin-control">
                            <label>Dampening</label>
                            <input type="range" id="reverb-dampening" min="100" max="5000" value="3000" step="100">
                            <div class="plugin-value" id="reverb-dampening-value">3000 Hz</div>
                        </div>
                        <div class="plugin-control">
                            <label>Wet Level</label>
                            <input type="range" id="reverb-wet" min="0" max="1" value="0.3" step="0.01">
                            <div class="plugin-value" id="reverb-wet-value">30%</div>
                        </div>
                        <div class="plugin-control">
                            <label>Dry Level</label>
                            <input type="range" id="reverb-dry" min="0" max="1" value="0.7" step="0.01">
                            <div class="plugin-value" id="reverb-dry-value">70%</div>
                        </div>
                    </div>
                    <div class="preset-selector">
                        <label>Preset:</label>
                        <select id="reverb-preset">
                            <option value="room">Small Room</option>
                            <option value="hall">Concert Hall</option>
                            <option value="plate">Plate</option>
                            <option value="cathedral">Cathedral</option>
                            <option value="ambient">Ambient</option>
                        </select>
                    </div>
                </div>
                
                <!-- Delay -->
                <div class="plugin-card">
                    <div class="plugin-header">
                        <div class="plugin-title">Delay</div>
                        <label class="plugin-toggle">
                            <input type="checkbox" id="delay-toggle">
                            <span class="plugin-slider"></span>
                        </label>
                    </div>
                    <div class="plugin-controls">
                        <div class="plugin-control">
                            <label>Time</label>
                            <input type="range" id="delay-time" min="0.01" max="1" value="0.25" step="0.01">
                            <div class="plugin-value" id="delay-time-value">0.25 s</div>
                        </div>
                        <div class="plugin-control">
                            <label>Feedback</label>
                            <input type="range" id="delay-feedback" min="0" max="0.9" value="0.4" step="0.01">
                            <div class="plugin-value" id="delay-feedback-value">40%</div>
                        </div>
                        <div class="plugin-control">
                            <label>Wet Level</label>
                            <input type="range" id="delay-wet" min="0" max="1" value="0.3" step="0.01">
                            <div class="plugin-value" id="delay-wet-value">30%</div>
                        </div>
                        <div class="plugin-control">
                            <label>Ping Pong</label>
                            <input type="checkbox" id="delay-pingpong">
                        </div>
                    </div>
                    <div class="preset-selector">
                        <label>Preset:</label>
                        <select id="delay-preset">
                            <option value="slapback">Slapback</option>
                            <option value="echo">Echo</option>
                            <option value="dotted">Dotted Eighth</option>
                            <option value="ambient">Ambient</option>
                            <option value="rhythmic">Rhythmic</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <!-- Third Row of Plugins -->
            <div class="plugin-row">
                <!-- Distortion -->
                <div class="plugin-card">
                    <div class="plugin-header">
                        <div class="plugin-title">Distortion</div>
                        <label class="plugin-toggle">
                            <input type="checkbox" id="dist-toggle">
                            <span class="plugin-slider"></span>
                        </label>
                    </div>
                    <div class="plugin-controls">
                        <div class="plugin-control">
                            <label>Amount</label>
                            <input type="range" id="dist-amount" min="0" max="1" value="0.2" step="0.01">
                            <div class="plugin-value" id="dist-amount-value">20%</div>
                        </div>
                        <div class="plugin-control">
                            <label>Tone</label>
                            <input type="range" id="dist-tone" min="100" max="5000" value="1500" step="100">
                            <div class="plugin-value" id="dist-tone-value">1500 Hz</div>
                        </div>
                        <div class="plugin-control">
                            <label>Wet Level</label>
                            <input type="range" id="dist-wet" min="0" max="1" value="0.3" step="0.01">
                            <div class="plugin-value" id="dist-wet-value">30%</div>
                        </div>
                    </div>
                    <div class="preset-selector">
                        <label>Preset:</label>
                        <select id="dist-preset">
                            <option value="warm">Warm</option>
                            <option value="overdrive">Overdrive</option>
                            <option value="fuzz">Fuzz</option>
                            <option value="bitcrush">Bit Crush</option>
                            <option value="heavy">Heavy</option>
                        </select>
                    </div>
                </div>
                
                <!-- Filter -->
                <div class="plugin-card">
                    <div class="plugin-header">
                        <div class="plugin-title">Filter</div>
                        <label class="plugin-toggle">
                            <input type="checkbox" id="filter-toggle">
                            <span class="plugin-slider"></span>
                        </label>
                    </div>
                    <div class="plugin-controls">
                        <div class="plugin-control">
                            <label>Type</label>
                            <select id="filter-type">
                                <option value="lowpass">Low Pass</option>
                                <option value="highpass">High Pass</option>
                                <option value="bandpass">Band Pass</option>
                                <option value="notch">Notch</option>
                            </select>
                        </div>
                        <div class="plugin-control">
                            <label>Frequency</label>
                            <input type="range" id="filter-freq" min="20" max="20000" value="1000" step="1">
                            <div class="plugin-value" id="filter-freq-value">1000 Hz</div>
                        </div>
                        <div class="plugin-control">
                            <label>Resonance</label>
                            <input type="range" id="filter-q" min="0.1" max="20" value="1" step="0.1">
                            <div class="plugin-value" id="filter-q-value">1</div>
                        </div>
                    </div>
                    <div class="preset-selector">
                        <label>Preset:</label>
                        <select id="filter-preset">
                            <option value="telephone">Telephone</option>
                            <option value="radio">Radio</option>
                            <option value="wah">Wah</option>
                            <option value="bass">Bass Boost</option>
                            <option value="air">Air</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <script>
        // Constants
        const NUM_STEPS = 16;
        const DRUM_INSTRUMENTS = [
            { name: "Kick", sound: "C1", color: "#bb86fc" },
            { name: "Snare", sound: "E1", color: "#03dac6" },
            { name: "Hi-hat Closed", sound: "G#1", color: "#cf6679" },
            { name: "Hi-hat Open", sound: "A#1", color: "#ffab40" },
            { name: "Clap", sound: "D1", color: "#64ffda" },
            { name: "Tom Low", sound: "F1", color: "#b388ff" },
            { name: "Tom High", sound: "B1", color: "#ff8a80" },
            { name: "Cymbal", sound: "C2", color: "#ffd180" }
        ];
        
        // Define different synth settings for different instruments
        const SYNTH_SETTINGS = {
            drums: {
                "C1": { // Kick
                    type: "kick",
                    pitchDecay: 0.05,
                    octaves: 5,
                    oscillator: { type: "sine" },
                    envelope: { attack: 0.001, decay: 0.4, sustain: 0.01, release: 0.4 }
                },
                "E1": { // Snare
                    type: "snare",
                    noise: { type: "white" },
                    oscillator: { type: "triangle" },
                    envelope: { attack: 0.005, decay: 0.1, sustain: 0, release: 0.1 }
                },
                "G#1": { // Hi-hat Closed
                    type: "hihat-closed",
                    noise: { type: "white" },
                    envelope: { attack: 0.001, decay: 0.05, sustain: 0, release: 0.05 }
                },
                "A#1": { // Hi-hat Open
                    type: "hihat-open",
                    noise: { type: "white" },
                    envelope: { attack: 0.001, decay: 0.3, sustain: 0, release: 0.3 }
                },
                "D1": { // Clap
                    type: "clap",
                    noise: { type: "pink" },
                    envelope: { attack: 0.001, decay: 0.2, sustain: 0, release: 0.1 }
                },
                "F1": { // Tom Low
                    type: "tom",
                    pitchDecay: 0.05,
                    octaves: 2,
                    oscillator: { type: "sine" },
                    envelope: { attack: 0.001, decay: 0.3, sustain: 0.03, release: 0.3 }
                },
                "B1": { // Tom High
                    type: "tom",
                    pitchDecay: 0.05,
                    octaves: 2,
                    oscillator: { type: "sine" },
                    envelope: { attack: 0.001, decay: 0.2, sustain: 0.03, release: 0.2 }
                },
                "C2": { // Cymbal
                    type: "cymbal",
                    noise: { type: "pink" },
                    envelope: { attack: 0.001, decay: 0.8, sustain: 0.1, release: 1.0 }
                }
            },
            brass: {
                trumpet: {
                    oscillator: { type: "square" },
                    envelope: { attack: 0.05, decay: 0.1, sustain: 0.9, release: 0.2 }
                },
                trombone: {
                    oscillator: { type: "sawtooth" },
                    envelope: { attack: 0.1, decay: 0.1, sustain: 0.8, release: 0.4 }
                },
                horn: {
                    oscillator: { type: "triangle" },
                    envelope: { attack: 0.2, decay: 0.2, sustain: 0.7, release: 0.5 }
                },
                tuba: {
                    oscillator: { type: "sine" },
                    envelope: { attack: 0.3, decay: 0.3, sustain: 0.6, release: 0.8 }
                }
            },
            strings: {
                violin: {
                    modulationIndex: 5,
                    harmonicity: 3.5,
                    oscillator: { type: "triangle" },
                    envelope: { attack: 0.1, decay: 0.3, sustain: 0.8, release: 1.0 }
                },
                viola: {
                    modulationIndex: 4,
                    harmonicity: 2.5,
                    oscillator: { type: "sine" },
                    envelope: { attack: 0.2, decay: 0.3, sustain: 0.7, release: 1.2 }
                },
                cello: {
                    modulationIndex: 3,
                    harmonicity: 2,
                    oscillator: { type: "triangle" },
                    envelope: { attack: 0.3, decay: 0.4, sustain: 0.6, release: 1.4 }
                },
                ensemble: {
                    modulationIndex: 6,
                    harmonicity: 4,
                    oscillator: { type: "sine" },
                    envelope: { attack: 0.1, decay: 0.2, sustain: 0.9, release: 1.5 }
                }
            }
        };
        
        // Effect presets
        const EFFECT_PRESETS = {
            eq: {
                flat: { low: 0, mid: 0, high: 0 },
                'bass-boost': { low: 6, mid: -2, high: 0 },
                'mid-scoop': { low: 3, mid: -6, high: 3 },
                'treble-boost': { low: -2, mid: 0, high: 6 },
                'vocal': { low: -3, mid: 3, high: 4 }
            },
            compressor: {
                gentle: { threshold: -20, ratio: 2, attack: 0.2, release: 0.5 },
                moderate: { threshold: -24, ratio: 4, attack: 0.1, release: 0.2 },
                aggressive: { threshold: -30, ratio: 8, attack: 0.05, release: 0.1 },
                limiter: { threshold: -2, ratio: 20, attack: 0.001, release: 0.01 },
                drums: { threshold: -24, ratio: 6, attack: 0.01, release: 0.1 }
            },
            reverb: {
                room: { size: 0.3, dampening: 4000, wet: 0.2, dry: 0.8 },
                hall: { size: 0.6, dampening: 3000, wet: 0.3, dry: 0.7 },
                plate: { size: 0.5, dampening: 2000, wet: 0.4, dry: 0.6 },
                cathedral: { size: 0.85, dampening: 1500, wet: 0.5, dry: 0.5 },
                ambient: { size: 0.7, dampening: 1000, wet: 0.6, dry: 0.5 }
            },
            delay: {
                slapback: { time: 0.1, feedback: 0.2, wet: 0.3 },
                echo: { time: 0.3, feedback: 0.4, wet: 0.4 },
                dotted: { time: 0.375, feedback: 0.5, wet: 0.3 },
                ambient: { time: 0.6, feedback: 0.6, wet: 0.2 },
                rhythmic: { time: 0.25, feedback: 0.7, wet: 0.4 }
            },
            distortion: {
                warm: { amount: 0.1, tone: 2000, wet: 0.3 },
                overdrive: { amount: 0.3, tone: 1500, wet: 0.4 },
                fuzz: { amount: 0.6, tone: 1000, wet: 0.5 },
                bitcrush: { amount: 0.8, tone: 3000, wet: 0.4 },
                heavy: { amount: 0.9, tone: 800, wet: 0.6 }
            },
            filter: {
                telephone: { type: 'bandpass', freq: 1000, q: 2 },
                radio: { type: 'bandpass', freq: 2500, q: 1 },
                wah: { type: 'lowpass', freq: 1500, q: 8 },
                bass: { type: 'lowpass', freq: 300, q: 1 },
                air: { type: 'highpass', freq: 8000, q: 0.5 }
            }
        };
        
        const NOTES = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
        const KEY_MAPPING = {
            'a': 'C4', 'w': 'C#4', 's': 'D4', 'e': 'D#4', 'd': 'E4', 'f': 'F4',
            't': 'F#4', 'g': 'G4', 'y': 'G#4', 'h': 'A4', 'u': 'A#4', 'j': 'B4',
            'k': 'C5', 'o': 'C#5', 'l': 'D5', 'p': 'D#5', ';': 'E5'
        };
        
        // Global Variables
        let currentStep = -1;
        let isPlaying = false;
        let currentTab = 'drums';
        let drumGrid = [];
        let pianoGrid = [];
        let brassGrid = [];
        let stringsGrid = [];
        let currentOctaves = {
            piano: 4,
            brass: 4,
            strings: 4
        };
        let lastPlayedNotes = {
            piano: null,
            brass: null,
            strings: null
        };
        
        // Set up Tone.js instruments and effects
        let masterVolume = null;
        let masterMeter = null;
        let drumSynth = null;
        let noiseSynth = null;  // For hi-hats, snares, cymbals
        let pianoSynth = null;
        let brassSynth = null;
        let stringsSynth = null;
        
        // Effects
        let equalizer = null;
        let compressor = null;
        let reverb = null;
        let delay = null;
        let distortion = null;
        let filter = null;
        
        // Keep track of audio initialization
        let audioInitialized = false;
        
        // Initialize audio with user interaction
        function initAudio() {
            console.log("Initializing audio...");
            
            // Explicitly resume audio context if it exists
            if (Tone.context && Tone.context.state !== "running") {
                Tone.context.resume().then(() => {
                    console.log("AudioContext successfully resumed!");
                }).catch(err => {
                    console.error("Failed to resume AudioContext:", err);
                });
            }
            
            // Clean up any existing instruments
            if (drumSynth) drumSynth.dispose();
            if (pianoSynth) pianoSynth.dispose();
            if (brassSynth) brassSynth.dispose();
            if (stringsSynth) stringsSynth.dispose();
            
            // Clean up any existing effects
            if (equalizer) equalizer.dispose();
            if (compressor) compressor.dispose();
            if (reverb) reverb.dispose();
            if (delay) delay.dispose();
            if (distortion) distortion.dispose();
            if (filter) filter.dispose();
            if (masterVolume) masterVolume.dispose();
            if (masterMeter) masterMeter.dispose();
            
            // Set up effects chain
            
            // Master Volume
            masterVolume = new Tone.Volume(0).toDestination();
            
            // Master Meter for visualization
            masterMeter = new Tone.Meter();
            masterVolume.connect(masterMeter);
            
            // Filter (will be connected optionally)
            filter = new Tone.Filter({
                type: "lowpass",
                frequency: 1000,
                Q: 1
            });
            
            // Distortion (will be connected optionally)
            distortion = new Tone.Distortion({
                distortion: 0.2,
                wet: 0.3
            });
            
            // Delay (will be connected optionally)
            delay = new Tone.FeedbackDelay({
                delayTime: 0.25,
                feedback: 0.4,
                wet: 0.3
            });
            
            // Reverb (will be connected optionally)
            reverb = new Tone.Reverb({
                decay: 2,
                preDelay: 0.01,
                wet: 0.3
            });
            
            // Compressor
            compressor = new Tone.Compressor({
                threshold: -24,
                ratio: 4,
                attack: 0.1,
                release: 0.2
            });
            
            // EQ (3-band)
            equalizer = new Tone.EQ3({
                low: 0,
                mid: 0,
                high: 0,
                lowFrequency: 250,
                highFrequency: 2500
            });
            
            // Connect effects chain - by default only compressor and EQ are active
            equalizer.connect(compressor);
            compressor.connect(masterVolume);
            
            // Connect optional effects when activated
            setupEffectsRouting();
            
            // Create separate synths for different types of drum sounds
            drumSynth = new Tone.MembraneSynth({
                pitchDecay: 0.05,
                octaves: 4,
                oscillator: {
                    type: "sine"
                },
                envelope: {
                    attack: 0.001,
                    decay: 0.4,
                    sustain: 0.01,
                    release: 0.4
                }
            }).connect(equalizer);
            
            // Noise synth for hi-hats, snares, cymbals
            noiseSynth = new Tone.NoiseSynth({
                noise: {
                    type: "white"
                },
                envelope: {
                    attack: 0.001,
                    decay: 0.2,
                    sustain: 0,
                    release: 0.2
                }
            }).connect(equalizer);
            
            // Set up piano as a polyphonic synth
            pianoSynth = new Tone.PolySynth(Tone.Synth, {
                oscillator: {
                    type: "triangle"
                },
                envelope: {
                    attack: 0.02,
                    decay: 0.1,
                    sustain: 0.3,
                    release: 1
                }
            }).connect(equalizer);
            
            // Create brass synth
            brassSynth = new Tone.PolySynth(Tone.Synth, SYNTH_SETTINGS.brass.trumpet).connect(equalizer);
            
            // Create strings synth
            stringsSynth = new Tone.PolySynth(Tone.Synth, SYNTH_SETTINGS.strings.violin).connect(equalizer);
            
            // Set initial volumes
            const initialVolume = -10; // Reduced volume (in dB)
            drumSynth.volume.value = initialVolume;
            pianoSynth.volume.value = initialVolume;
            brassSynth.volume.value = initialVolume;
            stringsSynth.volume.value = initialVolume;
            
            // Update volume slider
            document.getElementById("volume-slider").value = 75;
            document.getElementById("volume-value").textContent = "75%";
            
            // Start level meter animation
            animateMeter();
            
            // Mark audio as initialized
            audioInitialized = true;
            
            console.log("Audio initialized successfully");
        }
        
        // Setup effects routing based on toggle states
        function setupEffectsRouting() {
            // First disconnect all effects
            reverb.disconnect();
            delay.disconnect();
            distortion.disconnect();
            filter.disconnect();
            
            // Then connect them in series if they're active
            let lastEffect = equalizer;
            let nextEffect = compressor;
            
            if (document.getElementById("filter-toggle").checked) {
                lastEffect.connect(filter);
                lastEffect = filter;
            }
            
            if (document.getElementById("dist-toggle").checked) {
                lastEffect.connect(distortion);
                lastEffect = distortion;
            }
            
            if (document.getElementById("delay-toggle").checked) {
                lastEffect.connect(delay);
                lastEffect = delay;
            }
            
            if (document.getElementById("reverb-toggle").checked) {
                lastEffect.connect(reverb);
                lastEffect = reverb;
            }
            
            // Always connect the last effect to the compressor
            lastEffect.connect(nextEffect);
        }
        
        // Animate the master output meter
        function animateMeter() {
            if (!masterMeter) return;
            
            const updateMeter = () => {
                if (!isPlaying) {
                    // If not playing, gradually decrease the meter
                    const meterElement = document.getElementById("master-meter-level");
                    if (meterElement) {
                        const currentWidth = parseFloat(meterElement.style.width || "0");
                        if (currentWidth > 0) {
                            meterElement.style.width = Math.max(0, currentWidth - 2) + "%";
                        }
                    }
                } else {
                    // Get the level from the meter
                    const level = masterMeter.getValue();
                    // Convert to percentage (dB to linear scale)
                    // Assuming level is in dB, typically from -Infinity to 0
                    const normalizedLevel = Math.max(0, Math.min(100, (level + 60) * (100/60)));
                    
                    // Update the meter element
                    const meterElement = document.getElementById("master-meter-level");
                    if (meterElement) {
                        meterElement.style.width = normalizedLevel + "%";
                    }
                }
                
                // Request the next animation frame
                requestAnimationFrame(updateMeter);
            };
            
            // Start the animation
            requestAnimationFrame(updateMeter);
        }
        
        // Function to ensure DOM elements exist
        function ensureDomElements() {
            // Check for drum grid container
            const drumTab = document.getElementById("drums-tab");
            if (drumTab) {
                let gridContainer = drumTab.querySelector(".grid-container");
                if (!gridContainer) {
                    console.error("Grid container missing, creating it");
                    gridContainer = document.createElement("div");
                    gridContainer.className = "grid-container";
                    drumTab.appendChild(gridContainer);
                }
                
                let beatMarkers = gridContainer.querySelector("#beat-markers");
                if (!beatMarkers) {
                    console.log("Creating missing beat markers");
                    beatMarkers = document.createElement("div");
                    beatMarkers.id = "beat-markers";
                    beatMarkers.className = "beat-markers";
                    gridContainer.appendChild(beatMarkers);
                }
                
                let grid = gridContainer.querySelector("#grid");
                if (!grid) {
                    console.log("Creating missing grid");
                    grid = document.createElement("div");
                    grid.id = "grid";
                    gridContainer.appendChild(grid);
                }
            }
        }
        
        // Global tab switching function
        function switchTab(tabId) {
            console.log("switchTab called with:", tabId);
            
            // Update active tab
            document.querySelectorAll('.tab').forEach(t => {
                t.classList.remove('active');
                if (t.dataset.tab === tabId) {
                    t.classList.add('active');
                }
            });
            
            // Update visible content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
                content.style.display = 'none';
            });
            
            const tabContent = document.getElementById(tabId + '-tab');
            if (tabContent) {
                tabContent.classList.add('active');
                tabContent.style.display = 'block';
                
                // Special handling for different tabs
                if (tabId === 'drums') {
                    refreshDrumGrid();
                } else if (tabId === 'piano') {
                    refreshPianoElements();
                } else if (tabId === 'brass') {
                    refreshBrassElements();
                } else if (tabId === 'strings') {
                    refreshStringElements();
                } else if (tabId === 'plugins') {
                    updateEQCurve();
                }
            } else {
                console.error("Tab content not found for", tabId);
            }
            
            // Update current tab
            currentTab = tabId;
            
            console.log("Tab switched to:", tabId);
        }
        
        // Helper functions to refresh UI elements
        function refreshDrumGrid() {
            const drumGrid = document.getElementById('grid');
            if (drumGrid) {
                console.log("Forcing drum grid reflow");
                drumGrid.style.display = 'none';
                setTimeout(() => {
                    drumGrid.style.display = 'block';
                }, 50);
            }
        }
        
        function refreshPianoElements() {
            const pianoGrid = document.getElementById('piano-grid');
            const pianoKeyboard = document.getElementById('piano-keyboard');
            
            if (pianoGrid && pianoKeyboard) {
                pianoGrid.style.display = 'none';
                pianoKeyboard.style.display = 'none';
                setTimeout(() => {
                    pianoGrid.style.display = 'block';
                    pianoKeyboard.style.display = 'flex';
                }, 50);
            }
        }
        
        function refreshBrassElements() {
            const brassGrid = document.getElementById('brass-grid');
            const brassKeyboard = document.getElementById('brass-keyboard');
            
            if (brassGrid && brassKeyboard) {
                brassGrid.style.display = 'none';
                brassKeyboard.style.display = 'none';
                setTimeout(() => {
                    brassGrid.style.display = 'block';
                    brassKeyboard.style.display = 'flex';
                }, 50);
            }
        }
        
        function refreshStringElements() {
            const stringsGrid = document.getElementById('strings-grid');
            const stringsKeyboard = document.getElementById('strings-keyboard');
            
            if (stringsGrid && stringsKeyboard) {
                stringsGrid.style.display = 'none';
                stringsKeyboard.style.display = 'none';
                setTimeout(() => {
                    stringsGrid.style.display = 'block';
                    stringsKeyboard.style.display = 'flex';
                }, 50);
            }
        }
        
        // Update the EQ visualization curve
        function updateEQCurve() {
            const svgContainer = document.getElementById('eq-curve');
            if (!svgContainer) return;
            
            const width = svgContainer.clientWidth;
            const height = svgContainer.clientHeight;
            const lowGain = parseFloat(document.getElementById('eq-low').value);
            const midGain = parseFloat(document.getElementById('eq-mid').value);
            const highGain = parseFloat(document.getElementById('eq-high').value);
            
            // Normalize gain values to the SVG height
            const normalizeGain = (gain) => {
                // Map from -12...12 to height...0
                return height / 2 - (gain / 24) * height;
            };
            
            // Create path data
            const points = [
                { x: 0, y: normalizeGain(lowGain) },
                { x: width * 0.3, y: normalizeGain(lowGain) },
                { x: width * 0.5, y: normalizeGain(midGain) },
                { x: width * 0.7, y: normalizeGain(highGain) },
                { x: width, y: normalizeGain(highGain) }
            ];
            
            // Generate SVG path
            let pathData = `M ${points[0].x},${points[0].y}`;
            for (let i = 1; i < points.length; i++) {
                // Use curve for a smoother line
                if (i === 1 || i === points.length - 1) {
                    pathData += ` L ${points[i].x},${points[i].y}`;
                } else {
                    const prevPoint = points[i - 1];
                    const xc = (prevPoint.x + points[i].x) / 2;
                    const yc = (prevPoint.y + points[i].y) / 2;
                    pathData += ` Q ${xc},${prevPoint.y} ${xc},${yc}`;
                    pathData += ` Q ${xc},${points[i].y} ${points[i].x},${points[i].y}`;
                }
            }
            
            // Update the path
            const path = svgContainer.querySelector('.eq-line');
            if (path) {
                path.setAttribute('d', pathData);
            }
        }
        
        // Initialize the UI
        function initializeUI() {
            console.log("Debug: Initializing UI");
            
            // Reset any existing state
            drumGrid = [];
            pianoGrid = [];
            brassGrid = [];
            stringsGrid = [];
            
            // Ensure DOM elements exist before trying to populate them
            ensureDomElements();
            
            // Create UI elements with a slight delay to ensure DOM is ready
            setTimeout(() => {
                // Create drum sequencer UI
                createBeatMarkers("beat-markers");
                createDrumGrid();
                
                // Create piano UI
                createBeatMarkers("piano-beat-markers");
                createKeyboard("piano-keyboard", "piano");
                createInstrumentGrid("piano-grid", "piano");
                
                // Create brass UI
                createBeatMarkers("brass-beat-markers");
                createKeyboard("brass-keyboard", "brass");
                createInstrumentGrid("brass-grid", "brass");
                
                // Create strings UI
                createBeatMarkers("strings-beat-markers");
                createKeyboard("strings-keyboard", "strings");
                createInstrumentGrid("strings-grid", "strings");
                
                console.log("Setting initial tab state to 'drums'");
                document.getElementById('drums-tab').style.display = 'block';
                document.getElementById('piano-tab').style.display = 'none';
                document.getElementById('brass-tab').style.display = 'none';
                document.getElementById('strings-tab').style.display = 'none';
                document.getElementById('plugins-tab').style.display = 'none';
                
                // Initialize plugins UI
                initPluginsUI();
                
                // Force redraw of drum grid for visibility
                refreshDrumGrid();
            }, 300); // Increased timeout to ensure DOM is ready
            
            // Set up event listeners after DOM is ready
            setTimeout(() => {
                setupEventListeners();
                setupPluginsEventListeners();
            }, 500);
        }
        
        // Initialize plugins UI
        function initPluginsUI() {
            // Update EQ display
            updateEQCurve();
            
            // Update all plugin displays
            updatePluginDisplays();
        }
        
        // Update all plugin display values
        function updatePluginDisplays() {
            // EQ
            document.getElementById("eq-low-value").textContent = 
                document.getElementById("eq-low").value + " dB";
            document.getElementById("eq-mid-value").textContent = 
                document.getElementById("eq-mid").value + " dB";
            document.getElementById("eq-high-value").textContent = 
                document.getElementById("eq-high").value + " dB";
                
            // Compressor
            document.getElementById("comp-threshold-value").textContent = 
                document.getElementById("comp-threshold").value + " dB";
            document.getElementById("comp-ratio-value").textContent = 
                document.getElementById("comp-ratio").value + ":1";
            document.getElementById("comp-attack-value").textContent = 
                document.getElementById("comp-attack").value + " s";
            document.getElementById("comp-release-value").textContent = 
                document.getElementById("comp-release").value + " s";
                
            // Reverb
            document.getElementById("reverb-size-value").textContent = 
                document.getElementById("reverb-size").value;
            document.getElementById("reverb-dampening-value").textContent = 
                document.getElementById("reverb-dampening").value + " Hz";
            document.getElementById("reverb-wet-value").textContent = 
                Math.round(document.getElementById("reverb-wet").value * 100) + "%";
            document.getElementById("reverb-dry-value").textContent = 
                Math.round(document.getElementById("reverb-dry").value * 100) + "%";
                
            // Delay
            document.getElementById("delay-time-value").textContent = 
                document.getElementById("delay-time").value + " s";
            document.getElementById("delay-feedback-value").textContent = 
                Math.round(document.getElementById("delay-feedback").value * 100) + "%";
            document.getElementById("delay-wet-value").textContent = 
                Math.round(document.getElementById("delay-wet").value * 100) + "%";
                
            // Distortion
            document.getElementById("dist-amount-value").textContent = 
                Math.round(document.getElementById("dist-amount").value * 100) + "%";
            document.getElementById("dist-tone-value").textContent = 
                document.getElementById("dist-tone").value + " Hz";
            document.getElementById("dist-wet-value").textContent = 
                Math.round(document.getElementById("dist-wet").value * 100) + "%";
                
            // Filter
            document.getElementById("filter-freq-value").textContent = 
                document.getElementById("filter-freq").value + " Hz";
            document.getElementById("filter-q-value").textContent = 
                document.getElementById("filter-q").value;
        }
        
        // Create beat markers for all instruments
        function createBeatMarkers(containerId) {
            const beatMarkersContainer = document.getElementById(containerId);
            if (!beatMarkersContainer) {
                console.error(`Beat markers container ${containerId} not found!`);
                return;
            }
            
            beatMarkersContainer.innerHTML = ''; // Clear any existing markers
            
            for (let i = 0; i < NUM_STEPS; i++) {
                const marker = document.createElement("div");
                marker.className = "beat-marker";
                marker.textContent = i + 1;
                beatMarkersContainer.appendChild(marker);
            }
        }
        
        // Create the drum sequencer grid
        function createDrumGrid() {
            console.log("Creating drum grid...");
            const gridContainer = document.getElementById("grid");
            
            if (!gridContainer) {
                console.error("Cannot create drum grid - container not found!");
                return;
            }
            
            gridContainer.innerHTML = ''; // Clear any existing grid
            
            for (let row = 0; row < DRUM_INSTRUMENTS.length; row++) {
                const instrument = DRUM_INSTRUMENTS[row];
                const gridRow = document.createElement("div");
                gridRow.className = "grid-row";
                
                // Create row label
                const rowLabel = document.createElement("div");
                rowLabel.className = "row-label";
                rowLabel.textContent = instrument.name;
                gridRow.appendChild(rowLabel);
                
                // Create grid cells container
                const gridCells = document.createElement("div");
                gridCells.className = "grid-cells";
                
                // Create grid cells for this row
                drumGrid[row] = [];
                
                for (let col = 0; col < NUM_STEPS; col++) {
                    const cell = document.createElement("div");
                    cell.className = "grid-cell";
                    cell.style.backgroundColor = "rgba(255, 255, 255, 0.1)";
                    
                    // Store initial state (inactive)
                    drumGrid[row][col] = false;
                    
                    // Add click handler
                    cell.addEventListener("click", function() {
                        // Toggle cell state
                        drumGrid[row][col] = !drumGrid[row][col];
                        
                        // Update cell appearance
                        if (drumGrid[row][col]) {
                            cell.classList.add("active");
                            cell.style.backgroundColor = instrument.color;
                        } else {
                            cell.classList.remove("active");
                            cell.style.backgroundColor = "rgba(255, 255, 255, 0.1)";
                        }
                    });
                    
                    gridCells.appendChild(cell);
                }
                
                gridRow.appendChild(gridCells);
                gridContainer.appendChild(gridRow);
            }
            
            console.log("Drum grid created with", DRUM_INSTRUMENTS.length, "rows and", NUM_STEPS, "columns");
        }
        
        // Function to create a keyboard for piano, brass or strings
        function createKeyboard(containerId, instrumentType) {
            const keyboardContainer = document.getElementById(containerId);
            if (!keyboardContainer) {
                console.error(`Keyboard container ${containerId} not found!`);
                return;
            }
            
            keyboardContainer.innerHTML = '';
            
            // Get current octave for this instrument
            const currentOctave = currentOctaves[instrumentType];
            
            // Create one octave of piano keys
            const octaveDiv = document.createElement("div");
            octaveDiv.className = "octave";
            
            // Create white keys first (so they appear behind black keys)
            const whiteNotes = ['C', 'D', 'E', 'F', 'G', 'A', 'B'];
            const whiteKeyElements = [];
            
            for (let i = 0; i < whiteNotes.length; i++) {
                const key = document.createElement("div");
                key.className = "key white-key";
                key.dataset.note = whiteNotes[i] + currentOctave;
                key.dataset.instrument = instrumentType;
                
                // Add key label
                const keyLabel = document.createElement("div");
                keyLabel.className = "key-label";
                keyLabel.textContent = whiteNotes[i] + currentOctave;
                key.appendChild(keyLabel);
                
                // Add click handler
                key.addEventListener("mousedown", function() {
                    playNoteForInstrument(key.dataset.note, instrumentType);
                    key.classList.add("active");
                });
                
                key.addEventListener("mouseup", function() {
                    key.classList.remove("active");
                });
                
                key.addEventListener("mouseleave", function() {
                    key.classList.remove("active");
                });
                
                whiteKeyElements.push(key);
                octaveDiv.appendChild(key);
            }
            
            // Now add black keys (positioned absolutely over white keys)
            const blackNotes = ['C#', 'D#', '', 'F#', 'G#', 'A#', ''];
            const blackKeyPositions = [0, 1, null, 3, 4, 5, null]; // Positions relative to white keys
            
            for (let i = 0; i < blackNotes.length; i++) {
                if (blackNotes[i] === '') continue; // Skip positions with no black key
                
                const key = document.createElement("div");
                key.className = "key black-key";
                key.dataset.note = blackNotes[i] + currentOctave;
                key.dataset.instrument = instrumentType;
                
                // Position black key relative to its white key
                const position = blackKeyPositions[i];
                key.style.left = `calc(${position} * (100% / 7) + (100% / 14))`;
                
                // Add key label
                const keyLabel = document.createElement("div");
                keyLabel.className = "key-label";
                keyLabel.textContent = blackNotes[i] + currentOctave;
                key.appendChild(keyLabel);
                
                // Add click handler
                key.addEventListener("mousedown", function() {
                    playNoteForInstrument(key.dataset.note, instrumentType);
                    key.classList.add("active");
                });
                
                key.addEventListener("mouseup", function() {
                    key.classList.remove("active");
                });
                
                key.addEventListener("mouseleave", function() {
                    key.classList.remove("active");
                });
                
                octaveDiv.appendChild(key);
            }
            
            keyboardContainer.appendChild(octaveDiv);
            
            console.log(`${instrumentType} keyboard created for octave`, currentOctave);
        }
        
        // Function to create grid for instruments (piano, brass, strings)
        function createInstrumentGrid(containerId, instrumentType) {
            // Initialize the grid
            const gridContainer = document.getElementById(containerId);
            if (!gridContainer) {
                console.error(`Grid container ${containerId} not found!`);
                return;
            }
            
            gridContainer.innerHTML = '';
            
            // Get current octave for this instrument
            const currentOctave = currentOctaves[instrumentType];
            
            // Create rows for one octave (C4 to B4 by default)
            const notes = [];
            for (let i = 0; i < NOTES.length; i++) {
                notes.push(NOTES[i] + currentOctave);
            }
            
            // Reverse the array so higher notes are at the top
            notes.reverse();
            
            // Get the appropriate grid array
            let grid;
            let cellClass;
            
            if (instrumentType === 'piano') {
                grid = pianoGrid;
                cellClass = 'instrument-grid-cell';
            } else if (instrumentType === 'brass') {
                grid = brassGrid;
                cellClass = 'instrument-grid-cell brass-grid-cell';
            } else if (instrumentType === 'strings') {
                grid = stringsGrid;
                cellClass = 'instrument-grid-cell strings-grid-cell';
            }
            
            for (let row = 0; row < notes.length; row++) {
                const note = notes[row];
                const gridRow = document.createElement("div");
                gridRow.className = "instrument-grid-row";
                
                // Add note label
                const noteLabel = document.createElement("div");
                noteLabel.className = "note-label";
                noteLabel.textContent = note;
                gridRow.appendChild(noteLabel);
                
                // Create grid cells container
                const gridCells = document.createElement("div");
                gridCells.className = "instrument-grid-cells";
                
                // Initialize this row in the grid array if needed
                if (!grid[row]) {
                    grid[row] = [];
                }
                
                // Create cells for this row
                for (let col = 0; col < NUM_STEPS; col++) {
                    const cell = document.createElement("div");
                    cell.className = cellClass;
                    
                    // Initialize to inactive if not already set
                    if (grid[row][col] === undefined) {
                        grid[row][col] = false;
                    }
                    
                    // Set initial appearance based on state
                    if (grid[row][col]) {
                        cell.classList.add("active");
                    }
                    
                    // Add data attributes for row/col
                    cell.dataset.row = row;
                    cell.dataset.col = col;
                    cell.dataset.note = note;
                    cell.dataset.instrument = instrumentType;
                    
                    // Add click handler
                    cell.addEventListener("click", function() {
                        const r = parseInt(this.dataset.row);
                        const c = parseInt(this.dataset.col);
                        
                        // Toggle cell state
                        grid[r][c] = !grid[r][c];
                        
                        // Update cell appearance
                        if (grid[r][c]) {
                            this.classList.add("active");
                        } else {
                            this.classList.remove("active");
                        }
                    });
                    
                    gridCells.appendChild(cell);
                }
                
                gridRow.appendChild(gridCells);
                gridContainer.appendChild(gridRow);
            }
            
            console.log(`${instrumentType} grid created with`, notes.length, "rows and", NUM_STEPS, "columns");
        }
        
        // Function to play a note for specific instrument
        function playNoteForInstrument(note, instrumentType) {
            if (!audioInitialized) {
                console.log("Audio not initialized, initializing now...");
                initAudio();
            }
            
            // Update last played note for this instrument
            lastPlayedNotes[instrumentType] = note;
            
            // Update display
            const displayId = `${instrumentType}-current-note`;
            document.getElementById(displayId).textContent = note;
            
            // Get instrument settings
            let instrumentSettings;
            let synth;
            
            if (instrumentType === 'piano') {
                const pianoType = document.getElementById("piano-type-select").value;
                synth = pianoSynth;
                // We could update piano settings here based on pianoType
            } else if (instrumentType === 'brass') {
                const brassType = document.getElementById("brass-type-select").value;
                instrumentSettings = SYNTH_SETTINGS.brass[brassType];
                synth = brassSynth;
                
                // Update brass synth with selected settings
                synth.set({
                    oscillator: instrumentSettings.oscillator,
                    envelope: instrumentSettings.envelope
                });
            } else if (instrumentType === 'strings') {
                const stringType = document.getElementById("strings-type-select").value;
                instrumentSettings = SYNTH_SETTINGS.strings[stringType];
                synth = stringsSynth;
                
                // Update strings synth with selected settings
                synth.set({
                    oscillator: instrumentSettings.oscillator,
                    envelope: instrumentSettings.envelope
                });
            } else {
                // Default to piano
                synth = pianoSynth;
            }
            
            // Play the note
            synth.triggerAttackRelease(note, "8n");
        }
        
        // Function to add a note to a specific instrument grid
        function addNoteToGrid(instrumentType) {
            const lastPlayedNote = lastPlayedNotes[instrumentType];
            if (!lastPlayedNote) {
                console.log(`No note has been played for ${instrumentType} yet`);
                return;
            }
            
            // Determine which grid to use
            let grid;
            if (instrumentType === 'piano') {
                grid = pianoGrid;
            } else if (instrumentType === 'brass') {
                grid = brassGrid;
            } else if (instrumentType === 'strings') {
                grid = stringsGrid;
            } else {
                console.error(`Unknown instrument type: ${instrumentType}`);
                return;
            }
            
            // Find the row that corresponds to this note
            const gridId = `${instrumentType}-grid`;
            const noteRows = document.querySelectorAll(`#${gridId} .instrument-grid-row`);
            let rowFound = false;
            
            noteRows.forEach((row, index) => {
                const noteLabel = row.querySelector(".note-label");
                if (noteLabel && noteLabel.textContent === lastPlayedNote) {
                    rowFound = true;
                    
                    // Find the next available step
                    let nextStep = 0;
                    while (nextStep < NUM_STEPS && grid[index][nextStep]) {
                        nextStep++;
                    }
                    
                    // If no empty step found, use step 0
                    if (nextStep >= NUM_STEPS) {
                        nextStep = 0;
                    }
                    
                    // Set the cell at this position
                    grid[index][nextStep] = true;
                    
                    // Update the cell in the UI
                    const cell = row.querySelectorAll(".instrument-grid-cell")[nextStep];
                    if (cell) {
                        cell.classList.add("active");
                    }
                    
                    console.log(`Added ${instrumentType} note ${lastPlayedNote} at step ${nextStep + 1}`);
                }
            });
            
            if (!rowFound) {
                console.log(`Note ${lastPlayedNote} not found in current ${instrumentType} view`);
            }
        }
        
        // Set up all event listeners
        function setupEventListeners() {
            console.log("Setting up event listeners");
            
            // Play button
            const playButton = document.getElementById("play-button");
            if (playButton) {
                playButton.addEventListener("click", function() {
                    if (!audioInitialized) {
                        initAudio();
                    }
                    startSequencer();
                });
            } else {
                console.error("Play button not found!");
            }
            
            // Stop button
            const stopButton = document.getElementById("stop-button");
            if (stopButton) {
                stopButton.addEventListener("click", function() {
                    stopSequencer();
                });
            } else {
                console.error("Stop button not found!");
            }
            
            // Clear All button
            const clearAllButton = document.getElementById("clear-all-button");
            if (clearAllButton) {
                clearAllButton.addEventListener("click", function() {
                    clearAllCells();
                });
            } else {
                console.error("Clear All button not found!");
            }
            
            // Tempo slider
            const tempoSlider = document.getElementById("tempo-slider");
            if (tempoSlider) {
                tempoSlider.addEventListener("input", function() {
                    updateTempo(this.value);
                });
            } else {
                console.error("Tempo slider not found!");
            }
            
            // Volume slider
            const volumeSlider = document.getElementById("volume-slider");
            if (volumeSlider) {
                volumeSlider.addEventListener("input", function() {
                    updateVolume(this.value);
                });
            } else {
                console.error("Volume slider not found!");
            }
            
            // Set up instrument-specific controls
            setupInstrumentControls("piano");
            setupInstrumentControls("brass");
            setupInstrumentControls("strings");
            
            // Keyboard events for piano
            document.addEventListener("keydown", function(event) {
                if (event.repeat) return; // Prevent key repeat
                
                const note = KEY_MAPPING[event.key.toLowerCase()];
                if (note) {
                    // Play the note on the current instrument tab
                    playNoteForInstrument(note, currentTab === 'drums' ? 'piano' : currentTab);
                    
                    // Highlight the key if possible
                    const keyElement = document.querySelector(`.key[data-note="${note}"][data-instrument="${currentTab === 'drums' ? 'piano' : currentTab}"]`);
                    if (keyElement) {
                        keyElement.classList.add("active");
                    }
                }
            });
            
            document.addEventListener("keyup", function(event) {
                const note = KEY_MAPPING[event.key.toLowerCase()];
                if (note) {
                    // Remove highlight from key
                    const keyElement = document.querySelector(`.key[data-note="${note}"][data-instrument="${currentTab === 'drums' ? 'piano' : currentTab}"]`);
                    if (keyElement) {
                        keyElement.classList.remove("active");
                    }
                }
            });
        }
        
        // Setup event listeners for audio plugins
        function setupPluginsEventListeners() {
            // EQ
            document.getElementById("eq-toggle").addEventListener("change", function() {
                if (this.checked) {
                    // Get current values
                    const low = parseFloat(document.getElementById("eq-low").value);
                    const mid = parseFloat(document.getElementById("eq-mid").value);
                    const high = parseFloat(document.getElementById("eq-high").value);
                    
                    // Update equalizer
                    equalizer.low.value = low;
                    equalizer.mid.value = mid;
                    equalizer.high.value = high;
                } else {
                    // Bypass EQ (set all to 0)
                    equalizer.low.value = 0;
                    equalizer.mid.value = 0;
                    equalizer.high.value = 0;
                }
                
                setupEffectsRouting();
            });
            
            // EQ sliders
            document.getElementById("eq-low").addEventListener("input", function() {
                const value = parseFloat(this.value);
                document.getElementById("eq-low-value").textContent = value + " dB";
                if (document.getElementById("eq-toggle").checked) {
                    equalizer.low.value = value;
                }
                updateEQCurve();
            });
            
            document.getElementById("eq-mid").addEventListener("input", function() {
                const value = parseFloat(this.value);
                document.getElementById("eq-mid-value").textContent = value + " dB";
                if (document.getElementById("eq-toggle").checked) {
                    equalizer.mid.value = value;
                }
                updateEQCurve();
            });
            
            document.getElementById("eq-high").addEventListener("input", function() {
                const value = parseFloat(this.value);
                document.getElementById("eq-high-value").textContent = value + " dB";
                if (document.getElementById("eq-toggle").checked) {
                    equalizer.high.value = value;
                }
                updateEQCurve();
            });
            
            // EQ presets
            document.getElementById("eq-preset").addEventListener("change", function() {
                const preset = EFFECT_PRESETS.eq[this.value];
                if (preset) {
                    document.getElementById("eq-low").value = preset.low;
                    document.getElementById("eq-mid").value = preset.mid;
                    document.getElementById("eq-high").value = preset.high;
                    
                    // Update UI
                    document.getElementById("eq-low-value").textContent = preset.low + " dB";
                    document.getElementById("eq-mid-value").textContent = preset.mid + " dB";
                    document.getElementById("eq-high-value").textContent = preset.high + " dB";
                    
                    // Apply if EQ is active
                    if (document.getElementById("eq-toggle").checked) {
                        equalizer.low.value = preset.low;
                        equalizer.mid.value = preset.mid;
                        equalizer.high.value = preset.high;
                    }
                    
                    updateEQCurve();
                }
            });
            
            // Compressor
            document.getElementById("comp-toggle").addEventListener("change", function() {
                if (this.checked) {
                    // Get current values
                    const threshold = parseFloat(document.getElementById("comp-threshold").value);
                    const ratio = parseFloat(document.getElementById("comp-ratio").value);
                    const attack = parseFloat(document.getElementById("comp-attack").value);
                    const release = parseFloat(document.getElementById("comp-release").value);
                    
                    // Update compressor
                    compressor.threshold.value = threshold;
                    compressor.ratio.value = ratio;
                    compressor.attack.value = attack;
                    compressor.release.value = release;
                } else {
                    // Bypass compressor (set to minimal values)
                    compressor.threshold.value = 0;
                    compressor.ratio.value = 1;
                }
            });
            
            // Reverb-related event listeners
            document.getElementById("reverb-toggle").addEventListener("change", function() {
                setupEffectsRouting();
            });
            
            document.getElementById("reverb-size").addEventListener("input", function() {
                const value = parseFloat(this.value);
                document.getElementById("reverb-size-value").textContent = value;
                if (document.getElementById("reverb-toggle").checked) {
                    reverb.decay = value * 10; // Scale size to decay time
                }
            });
            
            document.getElementById("reverb-dampening").addEventListener("input", function() {
                const value = parseFloat(this.value);
                document.getElementById("reverb-dampening-value").textContent = value + " Hz";
            });
            
            document.getElementById("reverb-wet").addEventListener("input", function() {
                const value = parseFloat(this.value);
                document.getElementById("reverb-wet-value").textContent = Math.round(value * 100) + "%";
                if (document.getElementById("reverb-toggle").checked) {
                    reverb.wet.value = value;
                }
            });
            
            document.getElementById("reverb-dry").addEventListener("input", function() {
                const value = parseFloat(this.value);
                document.getElementById("reverb-dry-value").textContent = Math.round(value * 100) + "%";
            });
            
            // Reverb presets
            document.getElementById("reverb-preset").addEventListener("change", function() {
                const preset = EFFECT_PRESETS.reverb[this.value];
                if (preset) {
                    document.getElementById("reverb-size").value = preset.size;
                    document.getElementById("reverb-dampening").value = preset.dampening;
                    document.getElementById("reverb-wet").value = preset.wet;
                    document.getElementById("reverb-dry").value = preset.dry;
                    
                    // Update UI
                    document.getElementById("reverb-size-value").textContent = preset.size;
                    document.getElementById("reverb-dampening-value").textContent = preset.dampening + " Hz";
                    document.getElementById("reverb-wet-value").textContent = Math.round(preset.wet * 100) + "%";
                    document.getElementById("reverb-dry-value").textContent = Math.round(preset.dry * 100) + "%";
                    
                    // Apply if reverb is active
                    if (document.getElementById("reverb-toggle").checked) {
                        reverb.dispose();
                        reverb = new Tone.Reverb({
                            decay: preset.size * 10,
                            preDelay: 0.01,
                            wet: preset.wet
                        });
                        setupEffectsRouting();
                    }
                }
            });
            
            // Delay
            document.getElementById("delay-toggle").addEventListener("change", function() {
                setupEffectsRouting();
            });
            
            document.getElementById("delay-time").addEventListener("input", function() {
                const value = parseFloat(this.value);
                document.getElementById("delay-time-value").textContent = value + " s";
                if (document.getElementById("delay-toggle").checked) {
                    delay.delayTime.value = value;
                }
            });
            
            document.getElementById("delay-feedback").addEventListener("input", function() {
                const value = parseFloat(this.value);
                document.getElementById("delay-feedback-value").textContent = Math.round(value * 100) + "%";
                if (document.getElementById("delay-toggle").checked) {
                    delay.feedback.value = value;
                }
            });
            
            document.getElementById("delay-wet").addEventListener("input", function() {
                const value = parseFloat(this.value);
                document.getElementById("delay-wet-value").textContent = Math.round(value * 100) + "%";
                if (document.getElementById("delay-toggle").checked) {
                    delay.wet.value = value;
                }
            });
            
            // Delay presets
            document.getElementById("delay-preset").addEventListener("change", function() {
                const preset = EFFECT_PRESETS.delay[this.value];
                if (preset) {
                    document.getElementById("delay-time").value = preset.time;
                    document.getElementById("delay-feedback").value = preset.feedback;
                    document.getElementById("delay-wet").value = preset.wet;
                    
                    // Update UI
                    document.getElementById("delay-time-value").textContent = preset.time + " s";
                    document.getElementById("delay-feedback-value").textContent = Math.round(preset.feedback * 100) + "%";
                    document.getElementById("delay-wet-value").textContent = Math.round(preset.wet * 100) + "%";
                    
                    // Apply if delay is active
                    if (document.getElementById("delay-toggle").checked) {
                        delay.delayTime.value = preset.time;
                        delay.feedback.value = preset.feedback;
                        delay.wet.value = preset.wet;
                    }
                }
            });
            
            // Distortion
            document.getElementById("dist-toggle").addEventListener("change", function() {
                setupEffectsRouting();
            });
            
            document.getElementById("dist-amount").addEventListener("input", function() {
                const value = parseFloat(this.value);
                document.getElementById("dist-amount-value").textContent = Math.round(value * 100) + "%";
                if (document.getElementById("dist-toggle").checked) {
                    distortion.distortion = value;
                }
            });
            
            document.getElementById("dist-tone").addEventListener("input", function() {
                const value = parseFloat(this.value);
                document.getElementById("dist-tone-value").textContent = value + " Hz";
                // Tone control not directly supported in simplified Tone.Distortion
            });
            
            document.getElementById("dist-wet").addEventListener("input", function() {
                const value = parseFloat(this.value);
                document.getElementById("dist-wet-value").textContent = Math.round(value * 100) + "%";
                if (document.getElementById("dist-toggle").checked) {
                    distortion.wet.value = value;
                }
            });
            
            // Distortion presets
            document.getElementById("dist-preset").addEventListener("change", function() {
                const preset = EFFECT_PRESETS.distortion[this.value];
                if (preset) {
                    document.getElementById("dist-amount").value = preset.amount;
                    document.getElementById("dist-tone").value = preset.tone;
                    document.getElementById("dist-wet").value = preset.wet;
                    
                    // Update UI
                    document.getElementById("dist-amount-value").textContent = Math.round(preset.amount * 100) + "%";
                    document.getElementById("dist-tone-value").textContent = preset.tone + " Hz";
                    document.getElementById("dist-wet-value").textContent = Math.round(preset.wet * 100) + "%";
                    
                    // Apply if distortion is active
                    if (document.getElementById("dist-toggle").checked) {
                        distortion.distortion = preset.amount;
                        distortion.wet.value = preset.wet;
                    }
                }
            });
            
            // Filter
            document.getElementById("filter-toggle").addEventListener("change", function() {
                setupEffectsRouting();
            });
            
            document.getElementById("filter-type").addEventListener("change", function() {
                const value = this.value;
                if (document.getElementById("filter-toggle").checked) {
                    filter.type = value;
                }
            });
            
            document.getElementById("filter-freq").addEventListener("input", function() {
                const value = parseFloat(this.value);
                document.getElementById("filter-freq-value").textContent = value + " Hz";
                if (document.getElementById("filter-toggle").checked) {
                    filter.frequency.value = value;
                }
            });
            
            document.getElementById("filter-q").addEventListener("input", function() {
                const value = parseFloat(this.value);
                document.getElementById("filter-q-value").textContent = value;
                if (document.getElementById("filter-toggle").checked) {
                    filter.Q.value = value;
                }
            });
            
            // Filter presets
            document.getElementById("filter-preset").addEventListener("change", function() {
                const preset = EFFECT_PRESETS.filter[this.value];
                if (preset) {
                    document.getElementById("filter-type").value = preset.type;
                    document.getElementById("filter-freq").value = preset.freq;
                    document.getElementById("filter-q").value = preset.q;
                    
                    // Update UI
                    document.getElementById("filter-freq-value").textContent = preset.freq + " Hz";
                    document.getElementById("filter-q-value").textContent = preset.q;
                    
                    // Apply if filter is active
                    if (document.getElementById("filter-toggle").checked) {
                        filter.type = preset.type;
                        filter.frequency.value = preset.freq;
                        filter.Q.value = preset.q;
                    }
                }
            });
        }
        
        // Set up instrument controls
        function setupInstrumentControls(instrumentType) {
            // Octave controls
            const octaveDown = document.getElementById(`${instrumentType}-octave-down`);
            if (octaveDown) {
                octaveDown.addEventListener("click", function() {
                    if (currentOctaves[instrumentType] > 1) {
                        currentOctaves[instrumentType]--;
                        document.getElementById(`${instrumentType}-octave-display`).textContent = currentOctaves[instrumentType];
                        createKeyboard(`${instrumentType}-keyboard`, instrumentType);
                        createInstrumentGrid(`${instrumentType}-grid`, instrumentType);
                    }
                });
            }
            
            const octaveUp = document.getElementById(`${instrumentType}-octave-up`);
            if (octaveUp) {
                octaveUp.addEventListener("click", function() {
                    if (currentOctaves[instrumentType] < 7) {
                        currentOctaves[instrumentType]++;
                        document.getElementById(`${instrumentType}-octave-display`).textContent = currentOctaves[instrumentType];
                        createKeyboard(`${instrumentType}-keyboard`, instrumentType);
                        createInstrumentGrid(`${instrumentType}-grid`, instrumentType);
                    }
                });
            }
            
            // Add note to grid button
            const addNoteBtn = document.getElementById(`${instrumentType}-add-note-btn`);
            if (addNoteBtn) {
                addNoteBtn.addEventListener("click", function() {
                    addNoteToGrid(instrumentType);
                });
            }
            
            // Instrument type selector
            const typeSelect = document.getElementById(`${instrumentType}-type-select`);
            if (typeSelect) {
                typeSelect.addEventListener("change", function() {
                    // Update synth settings when type changes
                    if (instrumentType === 'brass') {
                        const settings = SYNTH_SETTINGS.brass[this.value];
                        brassSynth.set({
                            oscillator: settings.oscillator,
                            envelope: settings.envelope
                        });
                    } else if (instrumentType === 'strings') {
                        const settings = SYNTH_SETTINGS.strings[this.value];
                        stringsSynth.set({
                            oscillator: settings.oscillator,
                            envelope: settings.envelope
                        });
                    }
                    // Piano type changes handled in playNoteForInstrument function
                });
            }
        }
        
        // Start the sequencer loop
        function startSequencer() {
            if (isPlaying) return;
            
            console.log("Starting sequencer...");
            isPlaying = true;
            
            // Get tempo value from slider
            const tempo = parseInt(document.getElementById("tempo-slider").value);
            const stepTime = 60 / tempo; // Time for one step in seconds
            
            // Create a loop to step through the grid
            Tone.Transport.scheduleRepeat((time) => {
                // Increment the step
                currentStep = (currentStep + 1) % NUM_STEPS;
                
                // Remove 'playing' highlight from all cells
                document.querySelectorAll(".grid-cell.playing, .instrument-grid-cell.playing").forEach(cell => {
                    cell.classList.remove("playing");
                });
                
                // Add 'playing' highlight to current column
                const currentStepCells = document.querySelectorAll(`.grid-cell:nth-child(${currentStep + 1}), .instrument-grid-cell[data-col="${currentStep}"]`);
                currentStepCells.forEach(cell => {
                    cell.classList.add("playing");
                });
                
                // Play drum sounds for active cells
                for (let row = 0; row < DRUM_INSTRUMENTS.length; row++) {
                    if (drumGrid[row] && drumGrid[row][currentStep]) {
                        const sound = DRUM_INSTRUMENTS[row].sound;
                        const settings = SYNTH_SETTINGS.drums[sound];
                        
                        // Apply specific settings for this drum sound
                        if (settings) {
                            // Use appropriate synth based on drum type
                            if (settings.type === "hihat-closed" || settings.type === "hihat-open" || 
                                settings.type === "clap" || settings.type === "cymbal") {
                                // Percussive sounds that use noise
                                noiseSynth.noise.type = settings.noise ? settings.noise.type : "white";
                                noiseSynth.envelope.attack = settings.envelope.attack;
                                noiseSynth.envelope.decay = settings.envelope.decay;
                                noiseSynth.envelope.sustain = settings.envelope.sustain;
                                noiseSynth.envelope.release = settings.envelope.release;
                                
                                // Add filter for different noise colors
                                const duration = settings.envelope.decay + settings.envelope.release;
                                let freq = 1000;
                                if (settings.type === "hihat-closed") freq = 8000;
                                if (settings.type === "hihat-open") freq = 5000;
                                if (settings.type === "clap") freq = 2000;
                                if (settings.type === "cymbal") freq = 3000;
                                
                                // Create a temporary filter to shape the noise
                                const filter = new Tone.Filter(freq, "highpass").connect(equalizer);
                                noiseSynth.disconnect();
                                noiseSynth.connect(filter);
                                
                                // Play the noise with appropriate duration
                                noiseSynth.triggerAttackRelease(duration);
                                
                                // Reconnect noise after a brief delay
                                setTimeout(() => {
                                    noiseSynth.disconnect();
                                    noiseSynth.connect(equalizer);
                                    filter.dispose();
                                }, duration * 1000 + 100);
                            } else {
                                // Tonal percussion (kick, toms)
                                drumSynth.pitchDecay = settings.pitchDecay || 0.05;
                                drumSynth.octaves = settings.octaves || 4;
                                if (settings.oscillator) {
                                    drumSynth.oscillator.type = settings.oscillator.type;
                                }
                                if (settings.envelope) {
                                    drumSynth.envelope.attack = settings.envelope.attack;
                                    drumSynth.envelope.decay = settings.envelope.decay;
                                    drumSynth.envelope.sustain = settings.envelope.sustain;
                                    drumSynth.envelope.release = settings.envelope.release;
                                }
                                
                                // Play the drum note
                                drumSynth.triggerAttackRelease(
                                    sound, 
                                    settings.envelope.decay + "s", 
                                    "+0.005" // Slight delay to avoid clicks
                                );
                            }
                        }
                    }
                }
                
                // Play instrument notes for active cells in piano grid
                playInstrumentNotesAtStep(pianoGrid, pianoSynth, currentStep);
                
                // Play brass notes
                playInstrumentNotesAtStep(brassGrid, brassSynth, currentStep);
                
                // Play string notes
                playInstrumentNotesAtStep(stringsGrid, stringsSynth, currentStep);
                
            }, stepTime, "+0.1"); // Start after a small delay
            
            // Start the transport
            Tone.Transport.start();
        }
        
        // Helper function to play notes for an instrument at the current step
        function playInstrumentNotesAtStep(grid, synth, step) {
            const notes = [];
            
            // Collect all active notes in this column/step
            for (let row = 0; row < grid.length; row++) {
                if (grid[row] && grid[row][step]) {
                    // Find the corresponding note for this row
                    const cells = document.querySelectorAll(`.instrument-grid-cell[data-row="${row}"][data-col="${step}"]`);
                    if (cells.length > 0) {
                        const note = cells[0].dataset.note;
                        if (note) {
                            notes.push(note);
                        }
                    }
                }
            }
            
            // Play all notes together as a chord
            if (notes.length > 0) {
                synth.triggerAttackRelease(notes, "8n");
            }
        }
        
        // Stop the sequencer
        function stopSequencer() {
            isPlaying = false;
            Tone.Transport.stop();
            Tone.Transport.cancel(); // Clear all scheduled events
            
            // Reset current step
            currentStep = -1;
            
            // Remove 'playing' highlight from all cells
            document.querySelectorAll(".grid-cell.playing, .instrument-grid-cell.playing").forEach(cell => {
                cell.classList.remove("playing");
            });
            
            console.log("Sequencer stopped");
        }
        
        // Clear all grid cells
        function clearAllCells() {
            console.log("Clearing all cells");
            
            // Clear drum grid
            for (let row = 0; row < drumGrid.length; row++) {
                for (let col = 0; col < NUM_STEPS; col++) {
                    drumGrid[row][col] = false;
                }
            }
            
            // Clear piano grid
            for (let row = 0; row < pianoGrid.length; row++) {
                for (let col = 0; col < NUM_STEPS; col++) {
                    if (pianoGrid[row]) {
                        pianoGrid[row][col] = false;
                    }
                }
            }
            
            // Clear brass grid
            for (let row = 0; row < brassGrid.length; row++) {
                for (let col = 0; col < NUM_STEPS; col++) {
                    if (brassGrid[row]) {
                        brassGrid[row][col] = false;
                    }
                }
            }
            
            // Clear strings grid
            for (let row = 0; row < stringsGrid.length; row++) {
                for (let col = 0; col < NUM_STEPS; col++) {
                    if (stringsGrid[row]) {
                        stringsGrid[row][col] = false;
                    }
                }
            }
            
            // Update UI - remove all active classes from cells
            document.querySelectorAll(".grid-cell.active, .instrument-grid-cell.active").forEach(cell => {
                cell.classList.remove("active");
                if (cell.classList.contains("grid-cell")) {
                    cell.style.backgroundColor = "rgba(255, 255, 255, 0.1)";
                }
            });
        }
        
        // Update tempo
        function updateTempo(value) {
            const tempo = parseInt(value);
            document.getElementById("tempo-value").textContent = tempo + " BPM";
            
            // If playing, restart to apply new tempo
            if (isPlaying) {
                stopSequencer();
                startSequencer();
            }
        }
        
        // Update volume
        function updateVolume(value) {
            const volume = parseInt(value);
            document.getElementById("volume-value").textContent = volume + "%";
            
            // Convert percentage to dB (logarithmic scale)
            // 0% = -Infinity dB (mute), 100% = 0dB (full volume)
            let dBValue;
            if (volume === 0) {
                dBValue = -Infinity;
            } else {
                // Map 1-100 to -40-0 dB
                dBValue = (volume / 100) * 40 - 40;
            }
            
            if (masterVolume) {
                masterVolume.volume.value = dBValue;
            }
        }
        
        // Initialize the UI when DOM is fully loaded
        document.addEventListener('DOMContentLoaded', function() {
            console.log("DOM loaded, initializing UI...");
            initializeUI();
            
            // Force initialization of audio after a small delay
            setTimeout(function() {
                if (!audioInitialized) {
                    initAudio();
                }
            }, 1000);
        });
    </script>
</body>
</html>